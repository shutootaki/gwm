# gwm 改修方針: 残存ローカルブランチ & ブランチ自動クリーンアップ

## 1. 背景

- `gwm add -r <branch>` は `git worktree add <path> -b <branch> origin/<branch>` を実行する。
- worktree/ディレクトリは削除済みでも **ローカルブランチが残存** していると `-b` が衝突しエラーになる。
- 現状の `gwm remove` は worktree だけ削除し、ブランチは手動対応が必要。結果として再利用時に失敗し UX が低下する。

## 2. 解決指針

ユーザー体験 (成功率向上) と 安全性 (誤削除防止) の両立を図るため、下記 2 つを実装する。

| #   | 施策                                        | 目的                                                              | 安全対策                                         |
| --- | ------------------------------------------- | ----------------------------------------------------------------- | ------------------------------------------------ |
| ①   | **add コマンドのフォールバック**            | ローカルに既存ブランチがあっても 1 回で worktree 作成を成功させる | ブランチ削除は行わず checkout だけに留める       |
| ②   | **remove コマンドのブランチ整理オプション** | worktree 削除時に不要ブランチも掃除し、次回 add の衝突を防ぐ      | 未マージコミット確認 & 対話/明示的オプション必須 |

## 3. 詳細設計

### 3-1. `gwm add` 改良

1. `isRemote` 時も含め、実行前に `git show-ref --verify --quiet refs/heads/<branch>` でローカル存在を調査。
2. 存在する場合 … `git worktree add <path> <branch>` (既存ブランチ利用)
3. 存在しない場合 … 従来どおり `-b <branch> origin/<branch>`
4. エラーメッセージを具体化し、衝突時に `gwm remove --clean-branch` の提案を表示。

### 3-2. `gwm remove` 拡張

- 新オプション `--clean-branch` (`auto` / `ask` / `never`)
  - 省略時は `ask` (対話確認)。
- 削除対象 worktree の **ブランチ名** を収集し、削除完了後
  - `git worktree list` に同名が存在しない
  - かつローカルブランチ `git branch --list <branch>` が存在する
    …場合にクリーンアップ候補と判定。
- 未マージコミット有無を `git cherry` で判定。
  - 差分がある場合は警告 & デフォルトでスキップ (強制は `--force-branch`).

### 3-3. 設定ファイル (`config.toml`)

```toml
# 既定値
clean_branch = "ask"  # auto | ask | never
```

### 3-4. 変更箇所一覧

| ファイル                                  | 主な変更                                 |
| ----------------------------------------- | ---------------------------------------- |
| `src/hooks/useWorktree.ts`                | add コマンドのフォールバックロジック追加 |
| `src/components/WorktreeRemove.tsx`       | ブランチ整理 UI & ロジック追加           |
| `src/config.ts` & `docs/specification.md` | `clean_branch` 設定定義、CLI help 更新   |

## 4. 互換性・移行

- **Breaking change なし** — 既存フローに影響せず、失敗していたケースが成功に改善。
- デフォルト動作は `ask` で安全寄り。CI 等で自動掃除したい場合は `clean_branch = "auto"` を設定。

## 5. テスト計画

| シナリオ                                                    | 期待結果                             |
| ----------------------------------------------------------- | ------------------------------------ |
| ローカルに同名ブランチが存在 & worktree 無し → `gwm add -r` | フォールバックし正常に worktree 作成 |
| `gwm remove` → `ask` で "n" 選択                            | ブランチ残存、add はエラー           |
| `gwm remove --clean-branch=auto`                            | worktree とブランチ両方削除          |
| 未マージコミットあり & `auto`                               | 削除せず警告                         |

## 6. リリースノート (概要)

```
### Added
* `gwm remove` に `--clean-branch` オプションを追加しました。不要になったローカルブランチを安全に掃除できます。

### Changed
* `gwm add -r` がローカルに同名ブランチがある場合でも自動でフォールバックし、作成が失敗しにくくなりました。
```
