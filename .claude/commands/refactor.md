# Refactoring Code

# ゴール

ソースコードの実装を **外部挙動を一切変えずに**

- 可読性
- 保守性
- テスト容易性
- パフォーマンス
  を向上させる形でリファクタしてください。

# 必須条件 ― “壊さない” ための制約

1. 公開 API（関数シグネチャ／クラス定義／HTTP エンドポイントなど）は変更禁止
2. 既存ユニットテストが **すべて** 通過する互換性を維持
3. 言語ごとの公式スタイルガイド（例：Python→PEP 8、Java→Google Java Style）を遵守
4. 処理速度・メモリ使用量を **著しく悪化させない**
5. 追加ライブラリの導入・ビルド設定変更は事前了承がない限り不可

# 品質向上の指針（詳細版）

■ 基本原則

- **DRY / KISS / YAGNI** を徹底し、シンプルで重複のない実装にする
- **SOLID 原則**（SRP, OCP, LSP, ISP, DIP）を常に意識する
- **関数は 1 つの責務**、クラスは **1 つの概念** のみを表現

■ コード構造・モジュール設計

- コードを **機能ごと**・**レイヤーごと** に分割し、疎結合を保つ
- **循環依存の排除**：依存方向は一方通行（下 → 上）
- **依存性注入（DI）/ インターフェース分離** でテスタブルに
- **ファイルサイズ・関数長** を制御（目安：1 ファイル 400 行以内、1 関数 40 行以内）

■ 命名規則

- **意図を正確に表す名詞・動詞** を使用（例: `calculate_checksum`, `UserSession`）
- 省略語の使用を最小限にし、プロジェクト全体で一貫性を保つ
- 定数は **UPPER_SNAKE_CASE**、変数・関数は **lower_snake_case / camelCase**、クラスは **PascalCase** など公式スタイルに準拠

■ エラー処理・例外設計

- **早期リターン＋ガード節** でネストを浅く保つ
- **特定の例外型** を投げ、catch 側でハンドリングを集中管理
- 入力値の **妥当性検証** を入口で完結させ、後段をクリーンに
- **再試行・タイムアウト・フォールバック** を含む堅牢な戦略を適用

■ コメント・ドキュメンテーション

- **WHY（理由）** を書く。**WHAT** はコードとテストで自明に
- **Docstring／KDoc／JSDoc** など言語標準フォーマットを使用
- 公開 API の **引数・戻り値・副作用** を明確にする
- 大規模ロジックには **設計意図やアルゴリズム概要** を付記

■ テスト容易性

- **副作用の局所化** と **純粋関数化** でテストを単純化
- 可能なら **TDD** を想定した分割
- **境界値・異常系・並列実行** を網羅的にテストできる構造へ
- モック／スタブ注入を容易にするため **インターフェース** を明確化

■ パフォーマンス・スケーラビリティ

- **アルゴリズムとデータ構造** を見直し Big-O を最適化
- **メモリ割当とクリティカルパス** を可視化しボトルネックを排除
- I/O（DB・ネットワーク）は **バッチ化 / 非同期化 / キャッシュ** を活用
- 不要なオブジェクト生成を削減し **オブジェクトプール** や **インメモリ再利用** を検討

■ 並行性・スレッドセーフティ

- スレッド間共有を最小化し、**イミュータブルデータ** を利用
- **ロック粒度** を小さく、デッドロックを避ける設計
- 非同期コードは **エラーハンドリング** と **キャンセル処理** を明確に

# リファクタリング手順（推奨ワークフロー）

1. **コードの理解** – 仕様・目的・依存関係を把握
2. **ベースライン取得** – 現行テストを実行し通過を確認、パフォーマンス計測
3. **問題点の特定** – 重複・長い関数・深いネスト・命名・副作用などを洗い出し
4. **小さな改善単位で変更** – テスト → 変更 → テスト を短サイクルで繰り返す
5. **共通処理の抽出・関数分割** – SRP を意識
6. **命名とスタイル修正** – 公式スタイルガイドへの整形
7. **エラーハンドリング強化** – 明確な例外種別・ガード節追加
8. **ドキュメント更新** – WHY を Docstring/コメントで記述
9. **最終パフォーマンス確認** – ベースラインとの差分を測定
10. **最終テスト & レビュー** – 変更概要・diff・新コードを提示し完了

# プロセス

- 必要に応じて **先に質問** して不足情報を補完すること
- 内部でのステップバイステップ思考（scratchpad）は出力に含めないこと

# 出力形式（順序厳守）

1. **変更概要** – 箇条書き 10 項目以内
2. **unified diff** – `diff` ブロックで提示
3. **リファクタ後の完全コード** – `code` ブロックで提示  
   ※ 上記 3 セクション **のみ**。追加の解説・挨拶は不要。

# 対話ポリシー

不明点がある場合、リファクタ開始 **前** に「質問: …?」の形式で尋ねてください。
